<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pragati EcoSolar | Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
:root{
  --brand:#0f172a;
  --accent:#2563eb;
  --bg:#f1f5f9;
  --card:#ffffff;
  --border:rgba(0,0,0,.08);
  --text:#1f2937;
  --muted:#6b7280;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Poppins,system-ui;
  background:var(--bg);
  color:var(--text);
}

/* ================= LOGIN ================= */
.login-wrapper{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}
.login-box{
  background:#fff;
  width:360px;
  padding:30px;
  border-radius:18px;
  box-shadow:0 30px 70px rgba(0,0,0,.18);
}
.login-box h2{margin:0 0 6px}
.login-box p{margin:0 0 18px;font-size:.85rem;color:var(--muted)}
.login-box input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:12px;
  border:1px solid var(--border);
}
.login-box button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
}
.btn-primary{background:var(--brand);color:#fff}
.btn-secondary{margin-top:8px;background:#e5e7eb}
.btn-link{margin-top:10px;background:none;color:var(--accent)}
.error{margin-top:10px;color:#dc2626;font-size:.85rem}

/* ================= APP LAYOUT ================= */
#appLayout{
  display:none;
  min-height:100vh;
}

/* ================= SIDEBAR ================= */
.sidebar{
  width:240px;
  background:var(--brand);
  color:#fff;
  display:flex;
  flex-direction:column;
  padding:22px;
}
.sidebar h2{
  margin:0 0 24px;
  font-size:1.2rem;
}
.sidebar a{
  color:#e5e7eb;
  text-decoration:none;
  padding:10px 12px;
  border-radius:10px;
  margin-bottom:6px;
  display:block;
  font-size:.9rem;
}
.sidebar a:hover{
  background:rgba(255,255,255,.12);
}
.sidebar-footer{
  margin-top:auto;
  font-size:.75rem;
  opacity:.85;
}

/* ================= MAIN ================= */
.main{
  flex:1;
  padding:30px;
}

/* TOPBAR */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.logout{
  background:#dc2626;
  color:#fff;
  padding:8px 14px;
  border-radius:10px;
  border:none;
  cursor:pointer;
}

.section-title{
  margin:30px 0 14px;
  font-size:1.4rem;
}

/* CARD GRID */
.container{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:20px;
}
.card{
  background:var(--card);
  border-radius:18px;
  padding:20px;
  box-shadow:0 18px 40px rgba(0,0,0,.12);
  transition:.25s ease;
}
.card:hover{
  transform:translateY(-4px);
  box-shadow:0 25px 55px rgba(0,0,0,.18);
}
.card-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.card-header h3{
  margin:0;
  font-size:1.05rem;
}
.tag{
  font-size:.7rem;
  padding:4px 10px;
  border-radius:20px;
  background:#e0e7ff;
  color:#3730a3;
}
.card p{
  margin:12px 0;
  font-size:.85rem;
  color:var(--muted);
}
.links a{
  display:block;
  margin-top:8px;
  color:var(--accent);
  font-weight:500;
  text-decoration:none;
}
.links a:hover{text-decoration:underline}


.menu-btn{
  display:none;
  font-size:1.4rem;
  background:none;
  border:none;
  cursor:pointer;
}

@media(max-width:900px){
  .menu-btn{display:block}

  .sidebar{
    position:fixed;
    left:-260px;
    top:0;
    bottom:0;
    transition:.3s;
    z-index:999;
  }
  .sidebar.open{
    left:0;
  }
}


.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:16px;
  margin-bottom:30px;
}

.stat-card{
  background:linear-gradient(135deg,#2563eb,#1e40af);
  color:#fff;
  padding:20px;
  border-radius:18px;
  box-shadow:0 20px 40px rgba(37,99,235,.35);
}

.stat-card h3{
  margin:0;
  font-size:.9rem;
  opacity:.85;
}

.stat-card p{
  margin:10px 0 0;
  font-size:1.8rem;
  font-weight:600;
}


body.dark{
  --bg:#020617;
  --card:#020617;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --border:rgba(255,255,255,.08);
}
.card {
  transition: all 0.25s ease;
}

.card.hide {
  opacity: 0;
  transform: scale(0.96);
  pointer-events: none;
  display: none;
}

.card.show {
  display: block;
  opacity: 1;
  transform: scale(1);
}

.sidebar{
  width:240px;
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  background: rgba(15, 23, 42, 0.65);
  border-right: 1px solid rgba(255,255,255,0.12);
  color:#fff;
  display:flex;
  flex-direction:column;
  padding:22px;
}
.sidebar a{
  color:#e5e7eb;
  text-decoration:none;
  padding:12px 14px;
  border-radius:14px;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:.9rem;
  transition:.25s;
}

.sidebar a:hover,
.sidebar a.active{
  background: rgba(255,255,255,0.18);
}

.sidebar .count{
  background: rgba(255,255,255,0.18);
  padding:2px 8px;
  border-radius:999px;
  font-size:.7rem;
}
.fav-btn{
  background:none;
  border:none;
  font-size:1.1rem;
  cursor:pointer;
  opacity:.4;
  transition:.2s;
}

.fav-btn.active{
  opacity:1;
  transform: scale(1.15);
}
.card.recommended::before{
  content:"üß† Recommended";
  position:absolute;
  top:14px;
  right:14px;
  font-size:.7rem;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#fff;
  padding:4px 10px;
  border-radius:999px;
  box-shadow:0 6px 18px rgba(34,197,94,.4);
}
.card{
  position:relative;
  overflow:hidden;
}

.card::after{
  content:"";
  position:absolute;
  inset:0;
  background:radial-gradient(
    600px circle at var(--x,50%) var(--y,50%),
    rgba(255,255,255,.08),
    transparent 40%
  );
  opacity:0;
  transition:.25s;
  
  pointer-events: none;
}



.card:hover::after{
  opacity:1;
}

.card:hover{
  transform:translateY(-6px) scale(1.01);
  box-shadow:0 35px 80px rgba(0,0,0,.25);
}
.card:hover h3{
  transform:translateX(4px);
  transition:.25s;
}

.links a{display:block;color:#38bdf8;text-decoration:none;margin:6px 0}
iframe{width:100%;height:85vh;border:none;border-radius:16px;background:#fff}

.dashboard-locked .card {
  pointer-events: none;
  opacity: 0.4;
  filter: blur(1px);
}

.dashboard-locked .card.active {
  pointer-events: auto;
  opacity: 1;
  filter: none;
}

</style>


</head>

<body>






<!-- ================= LOGIN ================= -->
<div id="loginPage" class="login-wrapper">
  <div class="login-box">
    <h2 style="color: #1f2937;">Pragati EcoSolar</h2>
    <p style="color: #6b7280;">Internal Dashboard Login</p>

    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">

    <button class="btn-primary" onclick="login()">Login</button>
    <!-- <button class="btn-secondary" onclick="register()">Register</button> -->
    <button class="btn-link" onclick="resetPassword()">Forgot Password?</button>

    <div id="loginError" class="error"></div>
  </div>
</div>

<!-- ================= APP ================= -->
<div id="appLayout">


 <!-- SIDEBAR -->
<aside class="sidebar">
  <h2>‚ö° Pragati</h2>

  <a href="#" data-filter="all" class="active">
  üè† Dashboard <span class="count"></span>
</a>

<a href="#" data-filter="reports">
  üìä Reports <span class="count"></span>
</a>

<a href="#" data-filter="billing">
  üßæ Billing <span class="count"></span>
</a>

<a href="#" data-filter="utility">
  üõ† Utilities <span class="count"></span>
</a>


  <div class="sidebar-footer">
    Logged in as<br>
    <strong id="userEmailSidebar"></strong>
  </div>
</aside>


  <!-- MAIN -->
  <main class="main">

    <div class="topbar">
        <input 
  type="text"
  id="searchInput"
  placeholder="Search tools..."
  style="
    padding:10px 14px;
    border-radius:12px;
    border:1px solid var(--border);
    outline:none;
    min-width:220px;
  "
/>

    <div style="display:flex;align-items:center;gap:12px">
      <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <div>
        <h1>Dashboard</h1>
        <small id="userEmail"></small>
      </div>
    </div>

    <div style="display:flex;gap:10px">
      <button class="theme-btn" onclick="toggleTheme()">üåô</button>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </div>
<section class="stats">
  <div class="stat-card">
    <h3>üë• Users</h3>
    <p id="statUsers">‚Äî</p>
  </div>

  <div class="stat-card">
    <h3>üßæ Tools</h3>
    <p id="statTools">0</p>
  </div>

  <div class="stat-card">
    <h3>üõ† Utilities</h3>
    <p id="statUtilities">0</p>
  </div>

  <div class="stat-card">
    <h3>üåê Links</h3>
    <p id="statLinks">0</p>
  </div>
</section>


 

    <h2 class="section-title">Quick Links</h2>

    
     
    <section class="container" id="dashboardCards">

       <article class="card" data-category="dashboard">

      <div class="card-header">
        <h3>üåê Our Website</h3>
        <button class="fav-btn" title="Pin"> ‚≠ê</button>

        <span class="tag">Public</span>
      </div>
      <p>Main company website for customers & marketing.</p>
      <div class="links">
        <a href="https://www.pragatiecosolar.in/" target="_blank">Visit Pragati EcoSolar Website</a>
      </div>
    </article>

      <article class="card" data-category="dashboard">
        <div class="card-header">
            <h3>üìö Consumer Documentation</h3>
            <button class="fav-btn" title="Pin"> ‚≠ê</button>
            <span class="tag">Govt Portals</span>
        </div>
        <p>Official portals for PM SuryaGhar scheme and DCR documentation.</p>
        <div class="links">
            <a href="https://pmsuryaghar.gov.in/#/" target="_blank">PM SuryaGhar Portal</a>
            <a href="https://solardcrportal.nise.res.in/" target="_blank">DCR Portal</a>
        </div>
       </article>

    <article class="card" data-category="dashboard billing tool">
      <div class="card-header">
        <h3>üí≥ Billing & Invoicing</h3>
        <button class="fav-btn" title="Pin"> ‚≠ê</button>
        <span class="tag">Internal</span>
      </div>
      <p>Create invoices, track payments & manage billing.</p>
      <div class="links">
        <a href="https://mybillbook.in/" target="_blank">Open MyBillBook</a>
      </div>
    </article>
    

<article class="card" data-category="dashboard reports">
  <div class="card-header">
  <h3>üìä Reports</h3>
  <button class="fav-btn" title="Pin"> ‚≠ê</button>
  <span class="tag">Report</span>
  </div>
  <p>Analytics & exports.</p>
</article>

    <article class="card" data-category="dashboard">
      <div class="card-header">
        <h3>üßæ Quotation Tools</h3>
        <button class="fav-btn" title="Pin"> ‚≠ê</button>
        <span class="tag">Proposals</span>
      </div>
      <p>Generate quotations using SolarBee and MyBillBook store.</p>
      <div class="links">
        <a href="https://onehub.solarbee.in/" target="_blank">SolarBee OneHub</a>
        <a href="https://mybillbook.in/store/bhakti_solar_energy" target="_blank">MyBillBook Quotation Store</a>
      </div>
    </article>

    <article class="card" data-category="dashboard">
      <div class="card-header">
        <h3>üî¢ Solar Calculators</h3>
        <button class="fav-btn" title="Pin"> ‚≠ê</button>
        <span class="tag">Sizing</span>
      </div>
      <p>Calculate system size & savings.</p>
      <!-- <div class="links">
        <a href="hybridsolar.html" target="_blank">Hybrid Solar Calculator</a>
        <a href="ongridsolar.html" target="_blank">Ongrid Savings Calculator</a>
        <a href="3 kW Ongrid.html" target="_blank">3 kW Ongrid Calculator</a>
      </div> -->
      <div class="links">
  <a href="#" onclick="loadPage('hybridsolar', this)">Hybrid Solar Calculator</a>
  <a href="#" onclick="loadPage('ongridsolar', this)">Ongrid Savings Calculator</a>
  <a href="#" onclick="loadPage('3kwongrid', this)">3 kW Ongrid Calculator</a>
</div>

    </article>

    <article class="card" data-category="dashboard utility">
      <div class="card-header">
        <h3>üõ† Utility</h3>
        <button class="fav-btn" title="Pin"> ‚≠ê</button>
        <span class="tag">Documents</span>
      </div>
      <p>Generate receipts and vendor agreements.</p>
      <div class="links">
         <a href="#" onclick="loadPage('moneyreceipt', this)">Money Receipt Generator</a>
          <a href="#" onclick="loadPage('vendor', this)">Vendor Agreement Generator</a>

      </div>
    </article>
    
    </section>

    <div class="admin-only">
  <h3>User Management</h3>

  <!-- Add User -->
  <input id="newEmail" placeholder="Email">
  <input id="newPassword" type="password" placeholder="Password">
  <select id="newRole">
    <option value="staff">Staff</option>
    <option value="admin">Admin</option>
  </select>
  <button onclick="addUser()">Add User</button>
  <p id="addUserMsg"></p>

  <!-- User List -->
  <div id="userList"></div>
</div>
 
<!-- üîí PROTECTED CONTENT AREA -->
<hr id="toolDivider" style="display:none;">

<div id="toolWrapper" style="display:none;">
  <iframe id="toolFrame"></iframe>

  <button id="closeTool" onclick="unlockDashboard()">
    ‚¨Ö Back to Dashboard
  </button>
</div>

  </main>

</div>




<script>
function unlockDashboard() {
  const frame = document.getElementById("toolFrame");

  frame.src = "";

  document.getElementById("toolWrapper").style.display = "none";
  document.getElementById("toolDivider").style.display = "none";

  document.getElementById("dashboardCards").classList.remove("dashboard-locked");

  document.querySelectorAll(".card").forEach(c => c.classList.remove("active"));
}
</script>

<script>
function loadPage(page, el) {
  if (!window.auth || !window.auth.currentUser) {
    alert("‚ùå Login required");
    return;
  }

  const frame = document.getElementById("toolFrame");
  const wrapper = document.getElementById("toolWrapper");
  const divider = document.getElementById("toolDivider");

  const pages = {
    hybridsolar: "_hybridsolar.html",
    ongridsolar: "_ongridsolar.html",
    "3kwongrid": "_3kw_ongrid.html",
    moneyreceipt: "_receipt.html",
    vendor: "_vendor.html",
  };

  frame.src = pages[page];

  wrapper.style.display = "block";   // ‚úÖ show iframe area
  divider.style.display = "block";   // ‚úÖ show hr

  document.getElementById("dashboardCards").classList.add("dashboard-locked");

  document.querySelectorAll(".card").forEach(c => c.classList.remove("active"));
  el.closest(".card").classList.add("active");
}

</script>






<script>
function updateStats() {
  const cards = document.querySelectorAll(".card");

  let tools = 0;
  let utilities = 0;
  let links = 0;

  cards.forEach(card => {
    const cats = (card.dataset.category || "").split(" ");

    if (cats.includes("tool")) tools++;
    if (cats.includes("utility")) utilities++;

    // count links inside cards
    links += card.querySelectorAll("a").length;
  });

  document.getElementById("statTools").innerText = tools;
  document.getElementById("statUtilities").innerText = utilities;
  document.getElementById("statLinks").innerText = links;
}

updateStats();
</script>
<script>
function animateCount(el, value) {
  let start = 0;
  const speed = 20;

  const timer = setInterval(() => {
    start++;
    el.innerText = start;
    if (start >= value) clearInterval(timer);
  }, speed);
}

animateCount(statTools, parseInt(statTools.innerText));
animateCount(statUtilities, parseInt(statUtilities.innerText));
animateCount(statLinks, parseInt(statLinks.innerText));

// example placeholder
document.getElementById("statUsers").innerText = "Admin + Staff";

</script>

<script>
document.querySelectorAll(".card").forEach(card => {
  card.addEventListener("mousemove", e => {
    const r = card.getBoundingClientRect();
    card.style.setProperty("--x", e.clientX - r.left + "px");
    card.style.setProperty("--y", e.clientY - r.top + "px");
  });
});
</script>

<script>
const REC_KEY = "user_interest_score";
let interest = JSON.parse(localStorage.getItem(REC_KEY)) || {};

// track clicks
document.querySelectorAll(".card").forEach(card => {
  card.addEventListener("click", e => {
    if (e.target.tagName === "A") return; // allow normal link click

    const cats = (card.dataset.category || "").split(" ");
    cats.forEach(cat => {
      interest[cat] = (interest[cat] || 0) + 1;
    });

    localStorage.setItem(REC_KEY, JSON.stringify(interest));
  });
});
// apply recommendations
function applyRecommendations(){
  const maxInterest = Math.max(...Object.values(interest), 0);

  document.querySelectorAll(".card").forEach(card => {
    const cats = (card.dataset.category || "").split(" ");
    let score = 0;

    cats.forEach(c => score += interest[c] || 0);

    if(score === maxInterest && score > 0){
      card.classList.add("recommended");
      card.style.order = -2; // float to top
    }
  });
}

applyRecommendations();
</script>


<script>
    const favKey = "dashboard_favorites";
let favorites = JSON.parse(localStorage.getItem(favKey)) || [];

document.querySelectorAll(".fav-btn").forEach((btn, index) => {
  const card = btn.closest(".card");

  // restore favorite
  if (favorites.includes(index)) {
    btn.classList.add("active");
    card.style.order = -1;
  }

  btn.addEventListener("click", e => {
    e.stopPropagation();

    btn.classList.toggle("active");

    if (btn.classList.contains("active")) {
      favorites.push(index);
      card.style.order = -1;
    } else {
      favorites = favorites.filter(i => i !== index);
      card.style.order = "";
    }

    localStorage.setItem(favKey, JSON.stringify(favorites));
  });
});

</script>

<script>
    function updateSidebarCounts(){
  sidebarLinks.forEach(link => {
    const filter = link.dataset.filter;
    const countEl = link.querySelector(".count");

    let count = 0;

    cards.forEach(card => {
      const cats = (card.dataset.category || "").split(" ");
      if (filter === "all" || cats.includes(filter)) count++;
    });

    if (countEl) countEl.innerText = count;
  });
}

// call once on load
updateSidebarCounts();

</script>
<script>
document.addEventListener("DOMContentLoaded", () => {

  const sidebarLinks = document.querySelectorAll(".sidebar a[data-filter]");
  const cards = document.querySelectorAll(".card");
  const searchInput = document.getElementById("searchInput");

  let activeFilter = "all";

  // show all initially
  cards.forEach(card => card.classList.add("show"));

  function applyFilters(){
    const searchText = searchInput.value.toLowerCase();

    cards.forEach(card => {
      const categoryAttr = card.dataset.category || "";
      const categories = categoryAttr.split(" ");
      const text = card.innerText.toLowerCase();

      const matchCategory =
        activeFilter === "all" || categories.includes(activeFilter);

      const matchSearch = text.includes(searchText);

      if (matchCategory && matchSearch) {
        card.classList.remove("hide");
        card.classList.add("show");
      } else {
        card.classList.remove("show");
        card.classList.add("hide");
      }
    });
  }

  // sidebar click
  sidebarLinks.forEach(link => {
    link.addEventListener("click", e => {
      e.preventDefault();
      activeFilter = link.dataset.filter;

      sidebarLinks.forEach(l => l.classList.remove("active"));
      link.classList.add("active");

      applyFilters();
    });
  });

  // live search
  searchInput.addEventListener("input", applyFilters);

});
</script>

<script type="module">
/* ===============================
   üî• FIREBASE IMPORTS
================================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  sendPasswordResetEmail,
  onAuthStateChanged,
  signOut,
  createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  getDocs,
  collection,
  deleteDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* ===============================
   üîß FIREBASE CONFIG
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyCyIakQ4jzv_z7k_yXvBliTOqg687ZKjHk",
  authDomain: "pragati-dashboard.firebaseapp.com",
  projectId: "pragati-dashboard",
  storageBucket: "pragati-dashboard.firebasestorage.app",
  messagingSenderId: "580069668292",
  appId: "1:580069668292:web:70115744e2f5a83e016091",
  measurementId: "G-MYV9XGW3X1"
};

/* ===============================
   üöÄ INIT APPS
================================ */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const secondaryApp = initializeApp(firebaseConfig, "Secondary");
const secondaryAuth = getAuth(secondaryApp);

let CURRENT_USER_ROLE = null;

/* ===============================
   üéØ ELEMENTS
================================ */
const loginPage = document.getElementById("loginPage");
const appLayout = document.getElementById("appLayout");
const loginError = document.getElementById("loginError");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const userEmailSidebar = document.getElementById("userEmailSidebar");
const statUsers = document.getElementById("statUsers");

/* ===============================
   üîê LOGIN
================================ */
window.login = async () => {
  try {
    await signInWithEmailAndPassword(
      auth,
      emailInput.value.trim(),
      passwordInput.value
    );
  } catch (err) {
    loginError.innerText = err.message;
  }
};


/* ===============================
   ‚ôªÔ∏è SESSION HANDLER
================================ */

function animateCount(el, value) {
  let start = 0;
  const speed = 20;

  el.innerText = "0";

  const timer = setInterval(() => {
    start++;
    el.innerText = start;
    if (start >= value) clearInterval(timer);
  }, speed);
}

async function loadUserStats() {
  if (CURRENT_USER_ROLE !== "admin") {
    statUsers.innerText = "‚Äî";
    return;
  }

  const snap = await getDocs(collection(db, "users"));
  console.log("USER COUNT:", snap.size);

  animateCount(statUsers, snap.size);
}

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    loginPage.style.display = "flex";
    appLayout.style.display = "none";
    return;
  }

  const snap = await getDoc(doc(db, "users", user.uid));

  if (!snap.exists()) {
    await signOut(auth);
    alert("Access denied");
    return;
  }

  const data = snap.data();

  if (!data.canLogin) {
    await signOut(auth);
    alert("Account disabled");
    return;
  }

  CURRENT_USER_ROLE = data.role;

  loginPage.style.display = "none";
  appLayout.style.display = "flex";
  userEmailSidebar.innerText = data.email;

  applyRolePermissions();

  if (CURRENT_USER_ROLE === "admin") {
    loadUsers();
    loadUserStats(); 
  }
});

/* ===============================
   üîí ROLE UI CONTROL
================================ */
function applyRolePermissions() {
  document.querySelectorAll(".admin-only").forEach(el => {
    el.style.display = CURRENT_USER_ROLE === "admin" ? "block" : "none";
  });
}
window.toggleSidebar = () => {
  document.querySelector(".sidebar").classList.toggle("open");
};

window.toggleTheme = () => {
  document.body.classList.toggle("dark");
  localStorage.setItem(
    "theme",
    document.body.classList.contains("dark") ? "dark" : "light"
  );
};

if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark");
}
/* ===============================
   ‚ûï ADD USER (ADMIN ONLY)
================================ */
window.addUser = async () => {
  if (CURRENT_USER_ROLE !== "admin") {
    alert("Admin only");
    return;
  }

  const email = newEmail.value.trim();
  const password = newPassword.value;
  const role = newRole.value;
  const msg = addUserMsg;

  if (!email || !password) {
    msg.innerText = "Email & password required";
    return;
  }

  try {
    const cred = await createUserWithEmailAndPassword(
      secondaryAuth,
      email,
      password
    );

    await setDoc(doc(db, "users", cred.user.uid), {
      email,
      role,
      canLogin: true,
      createdAt: serverTimestamp()
    });

    await signOut(secondaryAuth);
    msg.innerText = "User added";
    loadUsers();

  } catch (err) {
    msg.innerText = err.message;
  }
};

/* ===============================
   üë• LOAD USERS
================================ */
async function loadUsers() {
  if (CURRENT_USER_ROLE !== "admin") return;

  const snap = await getDocs(collection(db, "users"));
  userList.innerHTML = "";

  snap.forEach(d => {
    const u = d.data();
    userList.innerHTML += `
      <div>
        <b>${u.email}</b> (${u.role})
        ${u.canLogin
          ? `<button onclick="blockUser('${d.id}')">Block</button>`
          : `<button onclick="unblockUser('${d.id}')">Unblock</button>`
        }
        ${d.id !== auth.currentUser.uid
  ? `<button onclick="deleteUser('${d.id}')">Delete</button>`
  : '<em>(You)</em>'
}
      </div>
    `;
  });
}


/* ===============================
   üö´ USER ACTIONS
================================ */
window.blockUser = async (uid) => {
  await updateDoc(doc(db, "users", uid), { canLogin: false });
  loadUsers();
};

window.unblockUser = async (uid) => {
  await updateDoc(doc(db, "users", uid), { canLogin: true });
  loadUsers();
};



window.deleteUser = async (uid) => {
  if (CURRENT_USER_ROLE !== "admin") return;

  if (!confirm("Delete this user permanently?")) return;

  await deleteDoc(doc(db, "users", uid));
  loadUsers();
};


/* ===============================
   üö™ LOGOUT
================================ */
window.logout = async () => {
  await signOut(auth);
  loginPage.style.display = "flex";
  appLayout.style.display = "none";
};

/* ===============================
   üîÅ RESET PASSWORD
================================ */
window.resetPassword = () => {
  sendPasswordResetEmail(auth, emailInput.value.trim())
    .then(() => alert("Reset email sent"))
    .catch(err => alert(err.message));
};
</script>
<script>
    document.querySelector('[data-filter="utility"]')
  .innerHTML += ` <small>(${document.querySelectorAll('[data-category*="utility"]').length})</small>`;

</script>


</body>
</html>



